# 06 - Consume a Generated Twilio Token in Gatsby with React Hooks

[Video link](https://egghead.io/lessons/gatsby-consume-a-generated-twilio-token-in-gatsby-with-react-hooks)

Back in our `use-twilio-video.js`, we're going to import axios, configure our TWILIO_TOKEN_URL we got from lesson 5 and extend our state so that we are prepared to store the JWT provided by our serverless function.

### hooks/use-twilio-video.js

```jsx
import axios from "axios";

const TWILIO_TOKEN_URL = ""; // url from twilio

const DEFAULT_STATE = {
  identity: false,
  roomName: false,
  token: false
};
```

We also need to update our `join` action in our reducer to keep track of the token. So, we'll set `token` to be `action.token`.

### hooks/use-twilio-video.js

```jsx
const reducer = (state, action) => {
  switch (action.type) {
    case "join":
      return {
        ...state,
        token: action.token,
        identity: action.identity,
        roomName: action.roomName
      };
    default:
      return DEFAULT_STATE;
  }
};
```

Now back in the `useTwilioVideo` hook we are going to add a new function, `getRoomToken`. This is going to take in the `identity` and `roomName` and asyncronously post these to the Twilio endpoint. When it receive back the token, it will dispatch all three of these values as a join action to our reducer. This will also mean we won't provide the dispatch method externally through this hook, rather we will expose the `getRoomToken` function we've just created.

### hooks/use-twilio-video.js

```jsx
const useTwilioVideo = () => {
  const [state, dispatch] = useContext(TwilioVideoContext);

  const getRoomToken = async ({ identity, roomName }) => {
    const result = await axios.post(TWILIO_TOKEN_URL, {
      identity,
      room: roomName
    });

    dispatch({ type: "join", token: result.data, identity, roomName });
  };

  return { state, getRoomToken };
};
```

At this point, Twilio didn't need to know the roomName but this could be used later for enhancements, specifically limiting the token to a single room.
We'll need to jump over and refactor our `join.js` file now.
Instead of getting dispatch from `useTwilioVideo` we will destructure `getRoomToken`. We can then update our `handleSubmit` function to use that instead of dispatch.

### components/join.js

```jsx
const Join = () => {
  const { state, getRoomToken } = useTwilioVideo();
  const [identity, setIdentity] = useState('');
  const [roomName, setRoomName] = useState('');

  const handleSubmit = event => {
    event.preventDefault();

    getRoomToken({ identity, roomName });
  };
```

Now, if we head back to the app, the default state should have the space for the token. When submit the form, all three fields should update.
![token tracked by state](https://res.cloudinary.com/dg3gyk0gu/image/upload/v1576277267/transcript-images/gatsby-consume-a-generated-twilio-token-in-gatsby-with-react-hooks.jpg)

## Personal take

**Summary**: This updates our `use-twilio-video` and `Join` components to request and store in state the JWT generated by Twilio.
